<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ì•„ì„œì•¤ê·¸ë ˆì´ìŠ¤ ê³ ê°ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- í˜ì´ì§€ ê¹œë¹¡ì„ ë°©ì§€ë¥¼ ìœ„í•œ ì´ˆê¸° ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ -->
    <script>
        (function() {
            // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            
            // CSS ìŠ¤íƒ€ì¼ì„ ë™ì ìœ¼ë¡œ ì¶”ê°€í•˜ì—¬ ì´ˆê¸° í‘œì‹œ ìƒíƒœ ì„¤ì •
            const style = document.createElement('style');
            if (isLoggedIn) {
                // ë¡œê·¸ì¸ ëœ ìƒíƒœ: ë¡œê·¸ì¸ í¼ ìˆ¨ê¸°ê³  ë©”ì¸ ì½˜í…ì¸  í‘œì‹œ
                style.textContent = `
                    #login-form { display: none !important; }
                    #main-content { display: block !important; }
                `;
            } else {
                // ë¡œê·¸ì¸ ì•ˆëœ ìƒíƒœ: ë©”ì¸ ì½˜í…ì¸  ìˆ¨ê¸°ê³  ë¡œê·¸ì¸ í¼ í‘œì‹œ
                style.textContent = `
                    #login-form { display: block !important; }
                    #main-content { display: none !important; }
                `;
            }
            document.head.appendChild(style);
        })();
    </script>
</head>
<body>
    <div class="container">


        <div id="login-form" class="card p-4 mx-auto" style="max-width: 500px;">
            <h3 class="text-center mb-4">ë¡œê·¸ì¸</h3>
            <form id="login">
                <div class="mb-3">
                    <label for="password" class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
                    <div class="input-group">
                        <input type="password" class="form-control" id="password" required placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                        <button class="btn btn-outline-secondary" type="button" id="password-toggle">
                            <i class="bi bi-eye" id="password-icon"></i>
                        </button>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary w-100">ë¡œê·¸ì¸</button>
            </form>
        </div>

        <div id="main-content" class="d-none">
            <!-- ëª¨ë°”ì¼ ìƒë‹¨ í—¤ë” -->
            <div class="mobile-header d-lg-none">
                <div class="d-flex justify-content-between align-items-center p-3 bg-light">
                    <button class="btn btn-outline-dark" id="sidebar-toggle">
                        <i class="bi bi-list"></i>
                    </button>
                    <div class="mobile-title" id="mobile-title-home" style="cursor: pointer;">
                        <div class="brand-name">ì•„ì„œì•¤ê·¸ë ˆì´ìŠ¤</div>
                        <div class="system-name">ê³ ê°ê´€ë¦¬ì‹œìŠ¤í…œ</div>
                    </div>
                    <button class="btn btn-outline-info btn-sm me-1" id="sync-status-btn" title="ë™ê¸°í™” ìƒíƒœ">
                        <i class="bi bi-cloud-check"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" id="mobile-logout-btn">
                        <i class="bi bi-box-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- ì‚¬ì´ë“œë°” -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <h4>ë©”ë‰´</h4>
                    <button class="btn btn-sm btn-outline-light d-lg-none" id="sidebar-close">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
                <ul class="sidebar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-page="customer-list">
                            <i class="bi bi-people"></i> ê³ ê° ëª©ë¡
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-page="add-customer">
                            <i class="bi bi-person-plus"></i> ê³ ê° ë“±ë¡
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-page="birthday-alerts">
                            <i class="bi bi-calendar-heart"></i> ìƒì¼ ì•Œë¦¼
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-page="gift-history">
                            <i class="bi bi-gift"></i> ì„ ë¬¼ ì´ë ¥
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-page="customer-ranking">
                            <i class="bi bi-trophy"></i> ê³ ê° ë“±ê¸‰
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-page="visit-tracking">
                            <i class="bi bi-calendar-check"></i> ë°©ë¬¸ ì£¼ê¸°
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-danger" href="#" id="reset-database" onclick="if(window.resetDatabase) window.resetDatabase(); return false;">
                            <i class="bi bi-trash3"></i> DB ì´ˆê¸°í™”
                        </a>
                    </li>
                </ul>
                <div class="sidebar-footer d-none d-lg-block">
                    <button class="btn btn-outline-light w-100" id="logout-btn">
                        <i class="bi bi-box-arrow-right"></i> ë¡œê·¸ì•„ì›ƒ
                    </button>
                </div>
            </div>

            <!-- ì‚¬ì´ë“œë°” ì˜¤ë²„ë ˆì´ (ëª¨ë°”ì¼ìš©) -->
            <div class="sidebar-overlay" id="sidebar-overlay"></div>

            <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
            <div class="main-content" id="main-content-area">

            <!-- ê³ ê° ëª©ë¡ í˜ì´ì§€ -->
            <div id="customer-list" class="page">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="mb-0">ê³ ê° ëª©ë¡</h3>
                    <button class="btn btn-success" id="export-excel-btn">
                        <i class="bi bi-download"></i> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>
                
                <!-- ê²€ìƒ‰ì°½ ê³ ì • ì„¹ì…˜ -->
                <div class="search-section">
                    <div class="row">
                        <div class="col-12">
                            <div class="input-group">
                                <input type="text" class="form-control" id="search-input" placeholder="ì´ë¦„, ì „í™”ë²ˆí˜¸, ë§¤ì¥, ë“±ê¸‰, ë©”ëª¨ë¡œ ê²€ìƒ‰">
                                <button class="btn btn-primary" id="search-btn">ê²€ìƒ‰</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ë²ˆí˜¸</th>
                                <th>ì´ë¦„</th>
                                <th>ì „í™”ë²ˆí˜¸</th>
                                <th class="mobile-hide">ìƒë…„ì›”ì¼</th>
                                <th class="mobile-hide">ì£¼ë°©ë¬¸ë§¤ì¥</th>
                                <th>ë“±ê¸‰</th>
                                <th class="mobile-hide">ìµœê·¼ ë°©ë¬¸ì¼</th>
                                <th>ìƒì„¸</th>
                            </tr>
                        </thead>
                        <tbody id="customer-list-body">
                            <!-- ê³ ê° ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì‚½ì…ë©ë‹ˆë‹¤ -->
                        </tbody>
                    </table>
                </div>
                
                <!-- ëª¨ë°”ì¼ ì „ìš© í•˜ë‹¨ ë²„íŠ¼ -->
                <div class="mobile-fixed-bottom d-md-none">
                    <button class="btn btn-success" id="mobile-add-customer-btn">
                        <i class="bi bi-plus-circle"></i> ê³ ê° ë“±ë¡
                    </button>
                </div>
            </div>

            <!-- ê³ ê° ë“±ë¡ í˜ì´ì§€ -->
            <div id="add-customer" class="page d-none">
                <h3 class="mb-3">ê³ ê° ë“±ë¡</h3>
                
                <!-- ê°œë³„ ê³ ê° ë“±ë¡ -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">ê°œë³„ ê³ ê° ë“±ë¡</h5>
                    </div>
                    <div class="card-body">
                        <form id="customer-form">
                            <div class="row">
                                <div class="col-12 col-md-6">
                                    <div class="mb-3">
                                        <label for="name" class="form-label">ì´ë¦„ *</label>
                                        <input type="text" class="form-control" id="name" required placeholder="ê³ ê° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                                    </div>
                                    <div class="mb-3">
                                        <label for="phone" class="form-label">ì „í™”ë²ˆí˜¸ *</label>
                                        <input type="tel" class="form-control" id="phone" required placeholder="010-0000-0000">
                                    </div>
                                    <div class="mb-3">
                                        <label for="gender" class="form-label">ì„±ë³„</label>
                                        <select class="form-select" id="gender">
                                            <option value="">ì„ íƒ ì•ˆí•¨</option>
                                            <option value="male">ë‚¨ì„±</option>
                                            <option value="female">ì—¬ì„±</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="birthdate" class="form-label">ìƒë…„ì›”ì¼</label>
                                        <input type="date" class="form-control" id="birthdate">
                                    </div>
                                </div>
                                <div class="col-12 col-md-6">
                                    <div class="mb-3">
                                        <label for="address" class="form-label">ì£¼ì†Œ</label>
                                        <input type="text" class="form-control" id="address" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                                    </div>
                                    <div class="mb-3">
                                        <label for="preferred-store" class="form-label">ì£¼ë°©ë¬¸ë§¤ì¥</label>
                                        <input type="text" class="form-control" id="preferred-store" placeholder="ì£¼ë¡œ ë°©ë¬¸í•˜ëŠ” ë§¤ì¥">
                                    </div>
                                    <div class="mb-3">
                                        <label for="email" class="form-label">ì´ë©”ì¼</label>
                                        <input type="email" class="form-control" id="email" placeholder="example@email.com">
                                    </div>
                                    <div class="mb-3">
                                        <label for="notes" class="form-label">ë©”ëª¨</label>
                                        <textarea class="form-control" id="notes" rows="3" placeholder="ê³ ê°ì— ëŒ€í•œ ì¶”ê°€ ì •ë³´ë‚˜ ë©”ëª¨"></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="d-grid d-md-block">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="bi bi-person-plus"></i> ê³ ê° ë“±ë¡
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <hr class="my-4">
                
                <!-- ì—‘ì…€ ì—…ë¡œë“œ ì„¹ì…˜ -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="excel-file" class="form-label">ì—‘ì…€ íŒŒì¼ ì„ íƒ (.xlsx, .xls)</label>
                            <input type="file" class="form-control" id="excel-file" accept=".xlsx,.xls">
                        </div>
                        <button type="button" class="btn btn-success" id="upload-excel-btn">
                            <i class="bi bi-upload"></i> ì—‘ì…€ ë°ì´í„° ì—…ë¡œë“œ
                        </button>
                        <button type="button" class="btn btn-info ms-2" id="download-template-btn">
                            <i class="bi bi-download"></i> í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
                        </button>
                    </div>
                </div>

                <!-- ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ ì•ˆë‚´ -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="mt-3">
                            <small class="text-muted">
                                <strong>ì—‘ì…€ íŒŒì¼ í˜•ì‹:</strong><br>
                                â€¢ <strong>ê³ ê°ì •ë³´ ì‹œíŠ¸:</strong> ì´ë¦„, ì„±ë³„, ì „í™”ë²ˆí˜¸, ìƒë…„ì›”ì¼, ì£¼ì†Œ, ì£¼ë°©ë¬¸ë§¤ì¥, ì´ë©”ì¼, ë©”ëª¨<br>
                                â€¢ <strong>êµ¬ë§¤ì´ë ¥ ì‹œíŠ¸:</strong> ê³ ê°ì „í™”ë²ˆí˜¸, êµ¬ë§¤ì¼, ìƒí’ˆëª…, <strong style="color:red;">ê°€ê²©</strong>, ì£¼ë¬¸ì¥ë²ˆí˜¸, êµ¬ë§¤ë§¤ì¥, ë‹´ë‹¹ì…€ëŸ¬, ê²°ì œë°©ë²•, ë©”ëª¨<br>
                                â€¢ <strong style="color:blue;">ì¤‘ìš”:</strong> êµ¬ë§¤ì´ë ¥ì˜ ê³ ê°ì „í™”ë²ˆí˜¸ëŠ” ê³ ê°ì •ë³´ì˜ ì „í™”ë²ˆí˜¸ì™€ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤<br>
                                â€¢ <strong style="color:blue;">ê°€ê²© í˜•ì‹:</strong> ìˆ«ìë§Œ ì…ë ¥ (ì˜ˆ: 280000, 2800000) - ì½¤ë§ˆë‚˜ 'ì›' ë¬¸ìëŠ” ìë™ ì œê±°ë©ë‹ˆë‹¤<br>
                                â€¢ ë‹¨ì¼ ì‹œíŠ¸ëŠ” ê³ ê°ì •ë³´ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤. í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ìƒì¼ ì•Œë¦¼ í˜ì´ì§€ -->
            <div id="birthday-alerts" class="page d-none">
                <h3 class="mb-3">ìƒì¼ ì•Œë¦¼</h3>
                <div class="card mb-3">
                    <div class="card-header">
                        <i class="bi bi-calendar-event"></i> ì´ë²ˆ ë‹¬ ìƒì¼
                    </div>
                    <div class="card-body">
                        <ul id="this-month-birthdays" class="list-group">
                            <!-- ì´ë²ˆ ë‹¬ ìƒì¼ ê³ ê° ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì‚½ì…ë©ë‹ˆë‹¤ -->
                        </ul>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-calendar-plus"></i> ë‹¤ìŒ ë‹¬ ìƒì¼
                    </div>
                    <div class="card-body">
                        <ul id="next-month-birthdays" class="list-group">
                            <!-- ë‹¤ìŒ ë‹¬ ìƒì¼ ê³ ê° ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì‚½ì…ë©ë‹ˆë‹¤ -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- ì„ ë¬¼ ì´ë ¥ í˜ì´ì§€ -->
            <div id="gift-history" class="page d-none">
                <h3 class="mb-3">ì„ ë¬¼ ì´ë ¥ ê´€ë¦¬</h3>
                <div class="row mb-3">
                    <div class="col">
                        <div class="input-group">
                            <input type="text" class="form-control" id="gift-search" placeholder="ê³ ê° ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰">
                            <button class="btn btn-primary" id="gift-search-btn">ê²€ìƒ‰</button>
                        </div>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-success" id="add-gift-btn">+ ì„ ë¬¼ ê¸°ë¡ ì¶”ê°€</button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ë²ˆí˜¸</th>
                                <th>ê³ ê°ëª…</th>
                                <th>ì„ ë¬¼ ì¢…ë¥˜</th>
                                <th>ì„ ë¬¼ ë‚´ìš©</th>
                                <th>ì œê³µ ì¼ì</th>
                                <th>ì œê³µ ì´ìœ </th>
                                <th>ìƒì„¸</th>
                            </tr>
                        </thead>
                        <tbody id="gift-history-body">
                            <!-- ì„ ë¬¼ ì´ë ¥ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì‚½ì…ë©ë‹ˆë‹¤ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ê³ ê° ë“±ê¸‰ í˜ì´ì§€ -->
            <div id="customer-ranking" class="page d-none">
                <h3 class="mb-3">ê³ ê° ë“±ê¸‰ ê´€ë¦¬</h3>
                
                <!-- ê²€ìƒ‰ ë° í•„í„° ì„¹ì…˜ -->
                <div class="row mb-4">
                    <div class="col-12 col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" id="ranking-search" placeholder="ê³ ê° ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰">
                            <button class="btn btn-primary" id="ranking-search-btn">ê²€ìƒ‰</button>
                        </div>
                    </div>
                    <div class="col-12 col-md-6 mt-2 mt-md-0">
                        <div class="row g-2">
                            <div class="col-6">
                                <select class="form-select" id="ranking-grade-filter">
                                    <option value="">ëª¨ë“  ë“±ê¸‰</option>
                                    <option value="VVIP">VVIP</option>
                                    <option value="VIP">VIP</option>
                                    <option value="ì¼ë°˜">ì¼ë°˜</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <select class="form-select" id="ranking-sort-filter">
                                    <option value="totalAmount-desc">êµ¬ë§¤ì•¡ ë†’ì€ìˆœ</option>
                                    <option value="totalAmount-asc">êµ¬ë§¤ì•¡ ë‚®ì€ìˆœ</option>
                                    <option value="purchaseCount-desc">êµ¬ë§¤íšŸìˆ˜ ë§ì€ìˆœ</option>
                                    <option value="purchaseCount-asc">êµ¬ë§¤íšŸìˆ˜ ì ì€ìˆœ</option>
                                    <option value="name-asc">ì´ë¦„ ê°€ë‚˜ë‹¤ìˆœ</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row row-cols-3 mb-4 g-2 g-md-4">
                    <div class="col">
                        <div class="card h-100 text-white bg-danger">
                            <div class="card-body p-2 p-md-3">
                                <h6 class="card-title mb-1 d-md-none">VVIP</h6>
                                <h5 class="card-title mb-2 d-none d-md-block">VVIP ê³ ê°</h5>
                                <p id="vvip-count" class="card-text display-6 display-md-4 mb-0">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card h-100 text-white bg-primary">
                            <div class="card-body p-2 p-md-3">
                                <h6 class="card-title mb-1 d-md-none">VIP</h6>
                                <h5 class="card-title mb-2 d-none d-md-block">VIP ê³ ê°</h5>
                                <p id="vip-count" class="card-text display-6 display-md-4 mb-0">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card h-100 text-white bg-secondary">
                            <div class="card-body p-2 p-md-3">
                                <h6 class="card-title mb-1 d-md-none">ì¼ë°˜</h6>
                                <h5 class="card-title mb-2 d-none d-md-block">ì¼ë°˜ ê³ ê°</h5>
                                <p id="regular-count" class="card-text display-6 display-md-4 mb-0">0</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <h4>ë“±ê¸‰ ê¸°ì¤€</h4>
                    <ul>
                        <li><strong>VVIP</strong>: ì´ êµ¬ë§¤ì•¡ 2,000ë§Œì› ì´ìƒ</li>
                        <li><strong>VIP</strong>: ì´ êµ¬ë§¤ì•¡ 1,000ë§Œì› ì´ìƒ</li>
                        <li><strong>ì¼ë°˜</strong>: ê·¸ ì™¸ ëª¨ë“  ê³ ê°</li>
                    </ul>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ë²ˆí˜¸</th>
                                <th>ì´ë¦„</th>
                                <th>ë“±ê¸‰</th>
                                <th>ì´ êµ¬ë§¤ì•¡</th>
                                <th>ì´ êµ¬ë§¤ íšŸìˆ˜</th>
                                <th>ë“±ê¸‰ ë³€ê²½ ì´ë ¥</th>
                            </tr>
                        </thead>
                        <tbody id="ranking-list-body">
                            <!-- ê³ ê° ë“±ê¸‰ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì‚½ì…ë©ë‹ˆë‹¤ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ë°©ë¬¸ ì£¼ê¸° í˜ì´ì§€ -->
            <div id="visit-tracking" class="page d-none">
                <h3 class="mb-3">ê³ ê° ë°©ë¬¸ ì£¼ê¸° ê´€ë¦¬</h3>
                <div class="row mb-3">
                    <div class="col">
                        <div class="input-group">
                            <input type="text" class="form-control" id="visit-search" placeholder="ê³ ê° ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰">
                            <button class="btn btn-primary" id="visit-search-btn">ê²€ìƒ‰</button>
                        </div>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-success" id="add-visit-btn">+ ë°©ë¬¸ ê¸°ë¡ ì¶”ê°€</button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ë²ˆí˜¸</th>
                                <th>ì´ë¦„</th>
                                <th>ìµœê·¼ ë°©ë¬¸ì¼</th>
                                <th>í‰ê·  ë°©ë¬¸ ì£¼ê¸°(ì¼)</th>
                                <th>ë°©ë¬¸ íšŸìˆ˜</th>
                                <th>ë‹¤ìŒ ì˜ˆìƒ ë°©ë¬¸ì¼</th>
                                <th>ìƒì„¸</th>
                            </tr>
                        </thead>
                        <tbody id="visit-list-body">
                            <!-- ë°©ë¬¸ ì£¼ê¸° ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì‚½ì…ë©ë‹ˆë‹¤ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ê³ ê° ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
            <div class="modal fade" id="customer-details-modal" tabindex="-1">
                <div class="modal-dialog modal-lg modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">ê³ ê° ìƒì„¸ ì •ë³´</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <ul class="nav nav-tabs" id="customerTabs">
                                <li class="nav-item">
                                    <a class="nav-link active" data-bs-toggle="tab" href="#info-tab">ê¸°ë³¸ ì •ë³´</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#purchase-tab">êµ¬ë§¤ ì´ë ¥</a>
                                </li>
                            </ul>
                            <div class="tab-content mt-3">
                                <div class="tab-pane fade show active" id="info-tab">
                                    <div id="customer-info-content">
                                        <!-- ê³ ê° ê¸°ë³¸ ì •ë³´ê°€ ì—¬ê¸°ì— ì‚½ì…ë©ë‹ˆë‹¤ -->
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="purchase-tab">
                                    <div class="tab-content-scrollable">
                                        <div id="purchase-history-content">
                                            <!-- êµ¬ë§¤ ì´ë ¥ì´ ì—¬ê¸°ì— ì‚½ì…ë©ë‹ˆë‹¤ -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <div class="w-100">
                                <div id="info-tab-footer" class="tab-footer">
                                    <button id="edit-customer-btn" class="btn btn-primary">ìˆ˜ì •</button>
                                    <button id="delete-customer-btn" class="btn btn-danger">ì‚­ì œ</button>
                                </div>
                                <div id="purchase-tab-footer" class="tab-footer d-none">
                                    <button id="add-purchase-btn" class="btn btn-success">+ êµ¬ë§¤ ê¸°ë¡ ì¶”ê°€</button>
                                    <button id="download-purchase-pdf" class="btn btn-info">PDF ë‹¤ìš´ë¡œë“œ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- êµ¬ë§¤ ê¸°ë¡ ì¶”ê°€ ëª¨ë‹¬ -->
            <div class="modal fade" id="add-purchase-modal" tabindex="-1">
                <div class="modal-dialog modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">êµ¬ë§¤ ê¸°ë¡ ì¶”ê°€</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="add-purchase-form">
                                <input type="hidden" id="purchase-customer-id">
                                
                                <div class="mb-3">
                                    <label for="purchase-date" class="form-label">êµ¬ë§¤ì¼ *</label>
                                    <input type="date" class="form-control" id="purchase-date" required>
                                </div>
                                
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <small class="text-muted">êµ¬ë§¤ ìƒí’ˆ ì •ë³´</small>
                                    </div>
                                    <div class="card-body">
                                        <div id="purchase-items">
                                            <div class="purchase-item mb-3">
                                                <div class="row g-2">
                                                    <div class="col-12 col-md-7">
                                                        <label class="form-label">ìƒí’ˆëª… *</label>
                                                        <input type="text" class="form-control item-name" required placeholder="êµ¬ë§¤í•˜ì‹  ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
                                                    </div>
                                                    <div class="col-12 col-md-5">
                                                        <label class="form-label">ê°€ê²© *</label>
                                                        <input type="number" class="form-control item-price" required placeholder="0">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="d-grid">
                                            <button type="button" class="btn btn-outline-secondary" id="add-item-btn">
                                                <i class="bi bi-plus-circle"></i> ìƒí’ˆ ì¶”ê°€
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="purchase-order-number" class="form-label">ì£¼ë¬¸ì¥ë²ˆí˜¸</label>
                                    <input type="text" class="form-control" id="purchase-order-number" placeholder="ì£¼ë¬¸ì¥ë²ˆí˜¸ (ì„ íƒì‚¬í•­)">
                                </div>
                                
                                <div class="row g-2 mb-3">
                                    <div class="col-12 col-md-6">
                                        <label for="purchase-store" class="form-label">êµ¬ë§¤ë§¤ì¥</label>
                                        <input type="text" class="form-control" id="purchase-store" placeholder="êµ¬ë§¤í•œ ë§¤ì¥ëª…">
                                    </div>
                                    <div class="col-12 col-md-6">
                                        <label for="purchase-staff" class="form-label">ë‹´ë‹¹ì…€ëŸ¬</label>
                                        <input type="text" class="form-control" id="purchase-staff" placeholder="ë‹´ë‹¹ ì§ì›ëª…">
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="payment-method" class="form-label">ê²°ì œ ë°©ë²• *</label>
                                    <select class="form-select" id="payment-method" required>
                                        <option value="">ê²°ì œ ë°©ë²•ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                        <option value="ì‹ ìš©ì¹´ë“œ">ì‹ ìš©ì¹´ë“œ</option>
                                        <option value="í˜„ê¸ˆ">í˜„ê¸ˆ</option>
                                        <option value="ê³„ì¢Œì´ì²´">ê³„ì¢Œì´ì²´</option>
                                        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="purchase-memo" class="form-label">ë©”ëª¨</label>
                                    <textarea class="form-control" id="purchase-memo" rows="3" placeholder="ì¶”ê°€ ë©”ëª¨ì‚¬í•­ (ì„ íƒì‚¬í•­)"></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                            <button type="submit" form="add-purchase-form" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> ì €ì¥
                            </button>
                        </div>
                    </div>
                </div>
            </div>


            </div> <!-- main-content-area ë‹«ê¸° -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- ê°œì„ ëœ í´ë¼ìš°ë“œ ë™ê¸°í™” ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
        // ì™„ì „ ìë™í™”ëœ í´ë¼ìš°ë“œ ë™ê¸°í™” ì„¤ì •
        window.CLOUD_SYNC = {
            enabled: true, // ë™ê¸°í™” í™œì„±í™”
            apiUrl: 'https://api.jsonbin.io/v3/b/67685b98ad19ca34f8d27c0a', // JSONBin API URL
            apiKey: '$2a$10$Yj/wJ8WRLu.P0zG5dkjK4.vKwPKDqw8Y1JOKqU8F4zq5XiKvYmLdO', // JSONBin API Key
            syncInterval: 15000, // 15ì´ˆë§ˆë‹¤ ë™ê¸°í™” (ë” ë¹ ë¥¸ ë™ê¸°í™”)
            rapidSyncInterval: 3000, // ë°ì´í„° ë³€ê²½ í›„ 3ì´ˆ ë‚´ ë¹ ë¥¸ ë™ê¸°í™”
            lastSyncTime: 0,
            isOnline: navigator.onLine,
            syncInProgress: false,
            autoSyncEnabled: true,
            maxRetries: 3,
            retryDelay: 2000
        };
        
        // ë„¤íŠ¸ì›Œí¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§
        window.addEventListener('online', () => {
            window.CLOUD_SYNC.isOnline = true;
            console.log('ë„¤íŠ¸ì›Œí¬ ì—°ê²°ë¨ - ë™ê¸°í™” ì¬ì‹œì‘');
            window.CloudSync.forceSyncToCloud();
        });
        
        window.addEventListener('offline', () => {
            window.CLOUD_SYNC.isOnline = false;
            console.log('ë„¤íŠ¸ì›Œí¬ ì—°ê²° ëŠê¹€ - ë¡œì»¬ì—ì„œë§Œ ì‘ì—…');
        });
        
        // ì™„ì „ ìë™í™”ëœ í´ë¼ìš°ë“œ ë™ê¸°í™” í•¨ìˆ˜ë“¤
        window.CloudSync = {
            // í´ë¼ìš°ë“œì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì¬ì‹œë„ ë¡œì§ í¬í•¨)
            async fetchFromCloud(retries = 0) {
                if (!window.CLOUD_SYNC.enabled || !window.CLOUD_SYNC.isOnline) return null;
                
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
                    
                    const response = await fetch(window.CLOUD_SYNC.apiUrl, {
                        method: 'GET',
                        headers: {
                            'X-Master-Key': window.CLOUD_SYNC.apiKey,
                            'Content-Type': 'application/json'
                        },
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        const data = await response.json();
                        return data.record;
                    } else if (response.status === 429 && retries < window.CLOUD_SYNC.maxRetries) {
                        // Rate limit ì˜¤ë¥˜ ì‹œ ì¬ì‹œë„
                        await new Promise(resolve => setTimeout(resolve, window.CLOUD_SYNC.retryDelay * (retries + 1)));
                        return this.fetchFromCloud(retries + 1);
                    } else {
                        console.log('í´ë¼ìš°ë“œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° HTTP ì˜¤ë¥˜:', response.status);
                    }
                } catch (error) {
                    if (error.name === 'AbortError') {
                        console.log('í´ë¼ìš°ë“œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° íƒ€ì„ì•„ì›ƒ');
                    } else if (retries < window.CLOUD_SYNC.maxRetries) {
                        // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ ì¬ì‹œë„
                        await new Promise(resolve => setTimeout(resolve, window.CLOUD_SYNC.retryDelay));
                        return this.fetchFromCloud(retries + 1);
                    } else {
                        console.log('í´ë¼ìš°ë“œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error);
                    }
                }
                return null;
            },
            
            // í´ë¼ìš°ë“œì— ë°ì´í„° ì €ì¥í•˜ê¸° (ì¬ì‹œë„ ë° ìµœì í™” ë¡œì§ í¬í•¨)
            async saveToCloud(data, retries = 0) {
                if (!window.CLOUD_SYNC.enabled || !window.CLOUD_SYNC.isOnline || window.CLOUD_SYNC.syncInProgress) return false;
                
                window.CLOUD_SYNC.syncInProgress = true;
                
                try {
                    const payload = {
                        customers: data.customers || [],
                        purchases: data.purchases || [],
                        gifts: data.gifts || [],
                        visits: data.visits || [],
                        rankHistory: data.rankHistory || [],
                        lastUpdated: Date.now(),
                        deviceId: this.getDeviceId(),
                        deviceName: this.getDeviceName(),
                        syncVersion: '3.0', // ë²„ì „ ì—…ê·¸ë ˆì´ë“œ
                        userAgent: navigator.userAgent.substring(0, 100) // ë””ë²„ê¹…ìš©
                    };
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000); // 15ì´ˆ íƒ€ì„ì•„ì›ƒ
                    
                    const response = await fetch(window.CLOUD_SYNC.apiUrl, {
                        method: 'PUT',
                        headers: {
                            'X-Master-Key': window.CLOUD_SYNC.apiKey,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        window.CLOUD_SYNC.lastSyncTime = Date.now();
                        localStorage.setItem('lastCloudSync', window.CLOUD_SYNC.lastSyncTime.toString());
                        this.showSyncStatus('âœ“ ë™ê¸°í™” ì™„ë£Œ', 'success');
                        console.log('í´ë¼ìš°ë“œ ë™ê¸°í™” ì„±ê³µ');
                        return true;
                    } else if (response.status === 429 && retries < window.CLOUD_SYNC.maxRetries) {
                        // Rate limit ì˜¤ë¥˜ ì‹œ ì¬ì‹œë„
                        await new Promise(resolve => setTimeout(resolve, window.CLOUD_SYNC.retryDelay * (retries + 1)));
                        return this.saveToCloud(data, retries + 1);
                    } else {
                        console.log('í´ë¼ìš°ë“œ ë°ì´í„° ì €ì¥ HTTP ì˜¤ë¥˜:', response.status);
                        this.showSyncStatus('âš  ë™ê¸°í™” ì‹¤íŒ¨', 'error');
                    }
                } catch (error) {
                    if (error.name === 'AbortError') {
                        console.log('í´ë¼ìš°ë“œ ë°ì´í„° ì €ì¥ íƒ€ì„ì•„ì›ƒ');
                        this.showSyncStatus('â± ë™ê¸°í™” íƒ€ì„ì•„ì›ƒ', 'error');
                    } else if (retries < window.CLOUD_SYNC.maxRetries) {
                        // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ ì¬ì‹œë„
                        await new Promise(resolve => setTimeout(resolve, window.CLOUD_SYNC.retryDelay));
                        return this.saveToCloud(data, retries + 1);
                    } else {
                        console.log('í´ë¼ìš°ë“œ ë°ì´í„° ì €ì¥ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error);
                        this.showSyncStatus('ğŸŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜', 'error');
                    }
                } finally {
                    window.CLOUD_SYNC.syncInProgress = false;
                }
                return false;
            },
            
            // ê¸°ê¸° ê³ ìœ  ID ìƒì„±
            getDeviceId() {
                let deviceId = localStorage.getItem('deviceId');
                if (!deviceId) {
                    deviceId = 'device_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
                    localStorage.setItem('deviceId', deviceId);
                }
                return deviceId;
            },
            
            // ê¸°ê¸° ì´ë¦„ ìƒì„±
            getDeviceName() {
                let deviceName = localStorage.getItem('deviceName');
                if (!deviceName) {
                    const userAgent = navigator.userAgent;
                    if (/Android/i.test(userAgent)) {
                        deviceName = 'Android ê¸°ê¸°';
                    } else if (/iPhone|iPad|iPod/i.test(userAgent)) {
                        deviceName = 'iOS ê¸°ê¸°';
                    } else if (/Windows/i.test(userAgent)) {
                        deviceName = 'Windows PC';
                    } else if (/Mac/i.test(userAgent)) {
                        deviceName = 'Mac';
                    } else {
                        deviceName = 'ê¸°íƒ€ ê¸°ê¸°';
                    }
                    deviceName += '_' + Date.now().toString().slice(-4);
                    localStorage.setItem('deviceName', deviceName);
                }
                return deviceName;
            },
            
            // í–¥ìƒëœ ë™ê¸°í™” ìƒíƒœ í‘œì‹œ
            showSyncStatus(message, type = 'info', duration = 3000) {
                const statusDiv = document.getElementById('sync-status') || this.createSyncStatusDiv();
                statusDiv.className = `sync-status ${type}`;
                statusDiv.textContent = message;
                statusDiv.style.display = 'block';
                
                // ìƒë‹¨ ë²„íŠ¼ ìƒíƒœë„ ì—…ë°ì´íŠ¸
                if (window.updateSyncStatus) {
                    window.updateSyncStatus(type === 'info' ? 'syncing' : type);
                }
                
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                    if (window.updateSyncStatus && type !== 'error') {
                        window.updateSyncStatus();
                    }
                }, duration);
            },
            
            // ë™ê¸°í™” ìƒíƒœ div ìƒì„±
            createSyncStatusDiv() {
                const statusDiv = document.createElement('div');
                statusDiv.id = 'sync-status';
                statusDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 10px 15px;
                    border-radius: 5px;
                    color: white;
                    font-size: 14px;
                    z-index: 9999;
                    display: none;
                `;
                document.body.appendChild(statusDiv);
                return statusDiv;
            },
            
            // ì™„ì „ ìë™í™”ëœ ë™ê¸°í™” ì‹œì‘
            startAutoSync() {
                if (!window.CLOUD_SYNC.enabled) return;
                
                console.log('ğŸš€ ì™„ì „ ìë™í™” ë™ê¸°í™” ì‹œì‘');
                this.showSyncStatus('ğŸ”„ ë™ê¸°í™” ì‹œì‘', 'info');
                
                // ì¦‰ì‹œ ë™ê¸°í™” ì‹œì‘ (í˜ì´ì§€ ë¡œë“œ ì‹œ)
                setTimeout(() => {
                    this.syncFromCloud();
                }, 1000);
                
                // ë¹ ë¥¸ ì£¼ê¸°ë¡œ ì •ê¸° ë™ê¸°í™” (15ì´ˆë§ˆë‹¤)
                setInterval(() => {
                    if (window.CLOUD_SYNC.isOnline && window.CLOUD_SYNC.autoSyncEnabled) {
                        this.syncFromCloud();
                    }
                }, window.CLOUD_SYNC.syncInterval);
                
                // ë°ì´í„° ë³€ê²½ ê°ì§€ ë° ì¦‰ì‹œ ë™ê¸°í™”
                this.watchDataChanges();
                
                // í˜ì´ì§€ í¬ì»¤ìŠ¤ ì‹œ ë™ê¸°í™”
                window.addEventListener('focus', () => {
                    if (window.CLOUD_SYNC.isOnline) {
                        console.log('í˜ì´ì§€ í¬ì»¤ìŠ¤ - ë™ê¸°í™” ì‹¤í–‰');
                        this.syncFromCloud();
                    }
                });
                
                // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ê°•ì œ ë™ê¸°í™”
                window.addEventListener('beforeunload', () => {
                    if (window.CLOUD_SYNC.isOnline) {
                        navigator.sendBeacon && this.beaconSync();
                        this.syncToCloud();
                    }
                });
                
                // ì˜¨ë¼ì¸ ìƒíƒœ ë³µì› ì‹œ ì¦‰ì‹œ ë™ê¸°í™”
                window.addEventListener('online', () => {
                    setTimeout(() => this.syncFromCloud(), 500);
                });
                
                // ê°€ì‹œì„± ë³€ê²½ ì‹œ ë™ê¸°í™”
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden && window.CLOUD_SYNC.isOnline) {
                        this.syncFromCloud();
                    }
                });
            },
            
            // í–¥ìƒëœ ë°ì´í„° ë³€ê²½ ê°ì§€ ë° ì¦‰ì‹œ ë™ê¸°í™”
            watchDataChanges() {
                const originalSave = window.saveDataToStorage;
                if (originalSave) {
                    let rapidSyncTimeout;
                    let normalSyncTimeout;
                    
                    window.saveDataToStorage = () => {
                        originalSave();
                        
                        // ê¸°ì¡´ íƒ€ì´ë¨¸ë“¤ ì·¨ì†Œ
                        if (rapidSyncTimeout) clearTimeout(rapidSyncTimeout);
                        if (normalSyncTimeout) clearTimeout(normalSyncTimeout);
                        
                        console.log('ë°ì´í„° ë³€ê²½ ê°ì§€ - ë™ê¸°í™” ì˜ˆì•½');
                        
                        // 3ì´ˆ í›„ ë¹ ë¥¸ ë™ê¸°í™” (ì‚¬ìš©ì ê²½í—˜ í–¥ìƒ)
                        rapidSyncTimeout = setTimeout(() => {
                            if (window.CLOUD_SYNC.enabled && window.CLOUD_SYNC.isOnline) {
                                console.log('ë¹ ë¥¸ ë™ê¸°í™” ì‹¤í–‰');
                                this.forceSyncToCloud();
                            }
                        }, window.CLOUD_SYNC.rapidSyncInterval);
                        
                        // 15ì´ˆ í›„ ì •ìƒ ë™ê¸°í™” (ì•ˆì „ë§)
                        normalSyncTimeout = setTimeout(() => {
                            if (window.CLOUD_SYNC.enabled && window.CLOUD_SYNC.isOnline) {
                                console.log('ì•ˆì „ë§ ë™ê¸°í™” ì‹¤í–‰');
                                this.forceSyncToCloud();
                            }
                        }, window.CLOUD_SYNC.syncInterval);
                    };
                }
                
                // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ë³€ê²½ ê°ì§€ (ë‹¤ë¥¸ íƒ­ì—ì„œì˜ ë³€ê²½ì‚¬í•­)
                window.addEventListener('storage', (e) => {
                    if (e.key && ['customers', 'purchases', 'gifts', 'visits'].includes(e.key)) {
                        console.log('ë‹¤ë¥¸ íƒ­ì—ì„œ ë°ì´í„° ë³€ê²½ ê°ì§€');
                        setTimeout(() => {
                            if (typeof loadCustomerList === 'function') loadCustomerList();
                            if (typeof loadBirthdayAlerts === 'function') loadBirthdayAlerts();
                            if (typeof loadRankingCounts === 'function') loadRankingCounts();
                        }, 1000);
                    }
                });
            },
            
            // Beacon APIë¥¼ ì´ìš©í•œ í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ë™ê¸°í™”
            beaconSync() {
                try {
                    const data = {
                        customers: JSON.parse(localStorage.getItem('customers') || '[]'),
                        purchases: JSON.parse(localStorage.getItem('purchases') || '[]'),
                        gifts: JSON.parse(localStorage.getItem('gifts') || '[]'),
                        visits: JSON.parse(localStorage.getItem('visits') || '[]'),
                        rankHistory: JSON.parse(localStorage.getItem('rankHistory') || '[]'),
                        lastUpdated: Date.now(),
                        deviceId: this.getDeviceId(),
                        deviceName: this.getDeviceName(),
                        syncVersion: '3.0'
                    };
                    
                    const payload = JSON.stringify(data);
                    const blob = new Blob([payload], { type: 'application/json' });
                    
                    navigator.sendBeacon(window.CLOUD_SYNC.apiUrl, blob);
                    console.log('Beacon ë™ê¸°í™” ì „ì†¡');
                } catch (error) {
                    console.log('Beacon ë™ê¸°í™” ì˜¤ë¥˜:', error);
                }
            },
            
            // í–¥ìƒëœ í´ë¼ìš°ë“œì—ì„œ ë¡œì»¬ë¡œ ë™ê¸°í™”
            async syncFromCloud() {
                if (window.CLOUD_SYNC.syncInProgress) return;
                
                const cloudData = await this.fetchFromCloud();
                if (!cloudData) {
                    // ì²« ì ‘ì† ì‹œ ë¡œì»¬ ë°ì´í„°ë¥¼ í´ë¼ìš°ë“œì— ì—…ë¡œë“œ
                    const hasLocalData = localStorage.getItem('customers') && 
                                        JSON.parse(localStorage.getItem('customers')).length > 0;
                    if (hasLocalData) {
                        console.log('ë¡œì»¬ ë°ì´í„° ë°œê²¬ - í´ë¼ìš°ë“œì— ì—…ë¡œë“œ');
                        this.forceSyncToCloud();
                    }
                    return;
                }
                
                // í´ë¼ìš°ë“œ ë°ì´í„°ê°€ ë” ìµœì‹ ì¸ì§€ í™•ì¸
                const localLastUpdated = parseInt(localStorage.getItem('lastUpdated') || '0');
                const cloudLastUpdated = cloudData.lastUpdated || 0;
                const currentDeviceId = this.getDeviceId();
                
                console.log('ë™ê¸°í™” í™•ì¸:', {
                    local: new Date(localLastUpdated).toLocaleString(),
                    cloud: new Date(cloudLastUpdated).toLocaleString(),
                    fromDevice: cloudData.deviceName,
                    isNewer: cloudLastUpdated > localLastUpdated,
                    isDifferentDevice: cloudData.deviceId !== currentDeviceId
                });
                
                if (cloudLastUpdated > localLastUpdated && cloudData.deviceId !== currentDeviceId) {
                    console.log(`ğŸ”„ ë°ì´í„° ì—…ë°ì´íŠ¸ ì ìš©: ${cloudData.deviceName || 'ë‹¤ë¥¸ ê¸°ê¸°'}ì—ì„œ ${new Date(cloudLastUpdated).toLocaleString()}`);
                    
                    // ë°ì´í„° ì—…ë°ì´íŠ¸ (ì•ˆì „í•œ ì—…ë°ì´íŠ¸)
                    this.updateLocalData('customers', cloudData.customers);
                    this.updateLocalData('purchases', cloudData.purchases);
                    this.updateLocalData('gifts', cloudData.gifts);
                    this.updateLocalData('visits', cloudData.visits);
                    this.updateLocalData('rankHistory', cloudData.rankHistory);
                    
                    localStorage.setItem('lastUpdated', cloudLastUpdated.toString());
                    
                    // í™”ë©´ ìƒˆë¡œê³ ì¹¨ (ì•ˆì „í•˜ê²Œ)
                    this.refreshUI();
                    
                    this.showSyncStatus(`ğŸ“± ${cloudData.deviceName || 'ë‹¤ë¥¸ ê¸°ê¸°'}ì—ì„œ ë™ê¸°í™”`, 'success');
                } else if (cloudLastUpdated <= localLastUpdated && cloudData.deviceId !== currentDeviceId) {
                    // ë¡œì»¬ ë°ì´í„°ê°€ ë” ìµœì‹ ì´ë©´ í´ë¼ìš°ë“œì— ì—…ë¡œë“œ
                    console.log('ë¡œì»¬ ë°ì´í„°ê°€ ë” ìµœì‹  - í´ë¼ìš°ë“œ ì—…ë°ì´íŠ¸');
                    setTimeout(() => this.forceSyncToCloud(), 2000);
                }
            },
            
            // ì•ˆì „í•œ ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸
            updateLocalData(key, data) {
                if (!data) return;
                
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    
                    // ì „ì—­ ë³€ìˆ˜ ì•ˆì „ ì—…ë°ì´íŠ¸
                    if (typeof window[key] !== 'undefined') {
                        window[key] = data;
                    }
                    if (typeof window[key.slice(0, -1)] !== 'undefined') { // customers -> customer í˜•íƒœë„ ì²´í¬
                        const singular = key.slice(0, -1);
                        if (typeof window[singular] !== 'undefined') {
                            window[singular] = data;
                        }
                    }
                    
                    console.log(`${key} ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ (${data.length}ê°œ í•­ëª©)`);
                } catch (error) {
                    console.error(`${key} ë°ì´í„° ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:`, error);
                }
            },
            
            // ì•ˆì „í•œ UI ìƒˆë¡œê³ ì¹¨
            refreshUI() {
                try {
                    setTimeout(() => {
                        if (typeof loadCustomerList === 'function') {
                            loadCustomerList();
                            console.log('ê³ ê° ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
                        }
                        if (typeof loadBirthdayAlerts === 'function') {
                            loadBirthdayAlerts();
                            console.log('ìƒì¼ ì•Œë¦¼ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
                        }
                        if (typeof loadRankingCounts === 'function') {
                            loadRankingCounts();
                            console.log('ë“±ê¸‰ í†µê³„ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
                        }
                        if (typeof loadGiftHistory === 'function') {
                            loadGiftHistory();
                        }
                        if (typeof loadVisitTracking === 'function') {
                            loadVisitTracking();
                        }
                    }, 500);
                } catch (error) {
                    console.error('UI ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥˜:', error);
                }
            },
            
            // ê°•ì œë¡œ í´ë¼ìš°ë“œì— ì—…ë¡œë“œ
            async forceSyncToCloud() {
                // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ì§ì ‘ ê°€ì ¸ì™€ì„œ ë™ê¸°í™” (ë” ì•ˆì „í•¨)
                const data = {
                    customers: JSON.parse(localStorage.getItem('customers') || '[]'),
                    purchases: JSON.parse(localStorage.getItem('purchases') || '[]'),
                    gifts: JSON.parse(localStorage.getItem('gifts') || '[]'),
                    visits: JSON.parse(localStorage.getItem('visits') || '[]'),
                    rankHistory: JSON.parse(localStorage.getItem('rankHistory') || '[]')
                };
                
                console.log('í´ë¼ìš°ë“œ ë™ê¸°í™” ë°ì´í„°:', {
                    customers: data.customers.length,
                    purchases: data.purchases.length,
                    gifts: data.gifts.length,
                    visits: data.visits.length
                });
                
                const success = await this.saveToCloud(data);
                if (success) {
                    console.log('ê°•ì œ í´ë¼ìš°ë“œ ë™ê¸°í™” ì™„ë£Œ');
                    localStorage.setItem('lastUpdated', Date.now().toString());
                    this.showSyncStatus('í´ë¼ìš°ë“œ ë™ê¸°í™” ì™„ë£Œ', 'success');
                } else {
                    console.log('í´ë¼ìš°ë“œ ë™ê¸°í™” ì‹¤íŒ¨');
                }
                return success;
            },
            
            // ë¡œì»¬ì—ì„œ í´ë¼ìš°ë“œë¡œ ë™ê¸°í™” (í˜¸í™˜ì„±)
            async syncToCloud() {
                return this.forceSyncToCloud();
            }
        };
        
        // ê°œì„ ëœ CSS ìŠ¤íƒ€ì¼ ì¶”ê°€
        const style = document.createElement('style');
        style.textContent = `
            .sync-status {
                transition: all 0.3s ease;
                font-weight: 500;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                border: none;
            }
            .sync-status.success {
                background: linear-gradient(45deg, #28a745, #20c997);
                animation: pulse-success 2s ease-in-out;
            }
            .sync-status.error {
                background: linear-gradient(45deg, #dc3545, #fd7e14);
                animation: shake 0.5s ease-in-out;
            }
            .sync-status.info {
                background: linear-gradient(45deg, #17a2b8, #6f42c1);
                animation: fade-in 0.3s ease-in-out;
            }
            @keyframes pulse-success {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.05); }
            }
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                75% { transform: translateX(5px); }
            }
            @keyframes fade-in {
                0% { opacity: 0; transform: translateY(-10px); }
                100% { opacity: 1; transform: translateY(0); }
            }
            
            /* ë™ê¸°í™” ìƒíƒœ í‘œì‹œê¸° */
            #sync-status-btn {
                transition: all 0.3s ease;
            }
            #sync-status-btn.syncing {
                animation: spin 1s linear infinite;
                color: #17a2b8 !important;
            }
            #sync-status-btn.success {
                color: #28a745 !important;
            }
            #sync-status-btn.error {
                color: #dc3545 !important;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
        
        // ë™ê¸°í™” ìƒíƒœ ë²„íŠ¼ ì—…ë°ì´íŠ¸
        function updateSyncButton(status) {
            const syncBtn = document.getElementById('sync-status-btn');
            if (syncBtn) {
                syncBtn.className = syncBtn.className.replace(/\b(syncing|success|error)\b/g, '');
                if (status) {
                    syncBtn.classList.add(status);
                }
            }
        }
        
        // ì „ì—­ ë™ê¸°í™” ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        window.updateSyncStatus = updateSyncButton;
    </script>
    
    <script src="app.js"></script>
</body>
</html> 